<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSC Demurrage Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* Borrowing styles from your templates */
        :root {
            --msc-blue: #005DAA;
            --msc-light-blue: #f0f7ff;
            --msc-text: #333;
        }
        body {
            background-color: #f8f9fa;
            color: var(--msc-text);
        }
        .header {
            background-color: var(--msc-blue);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        .header .msc-logo {
            font-size: 2.5rem;
            font-weight: bold;
            font-style: italic;
            letter-spacing: 2px;
        }
        .search-card {
            transition: all 0.3s ease-in-out;
        }
        .results-card {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            display: none; /* Hidden by default */
        }
        .results-card.show {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }
        .report-header {
            background-color: var(--msc-blue);
            color: white;
            padding: 1rem 1.5rem;
        }
        .section-title {
            color: var(--msc-blue);
            font-weight: bold;
            border-bottom: 2px solid var(--msc-blue);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .charges-table th {
            background-color: var(--msc-blue);
            color: white;
        }
        .total-row {
            background-color: var(--msc-light-blue);
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--msc-blue);
        }
        .status-paid { color: #198754; font-weight: bold; }
        .status-unpaid { color: #dc3545; font-weight: bold; }
        .status-partially_paid { color: #ffc107; font-weight: bold; }
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .print-shadow-none { box-shadow: none !important; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <header class="header no-print">
        <div class="msc-logo">MSC</div>
        <div class="fs-5 mt-2">Mediterranean Shipping Company</div>
        <p class="lead">Container Demurrage Portal - Chittagong</p>
    </header>

    <div class="container my-5">
        <div class="card shadow-sm search-card no-print">
            <div class="card-body p-4">
                <form id="search-form">
                    <label for="bl-search" class="form-label fs-5">Bill of Lading Search</label>
                    <div class="input-group">
                        <input type="text" id="bl-search" class="form-control form-control-lg" placeholder="Enter B/L Number" required>
                        <button class="btn btn-primary" type="submit" style="background-color: var(--msc-blue);">
                            <i class="bi bi-search me-2"></i>Search
                        </button>
                    </div>
                </form>
                <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>

        <div id="results-card" class="card shadow-lg mt-5 results-card print-shadow-none">
            <div id="report-content">
                <div class="report-header">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="mb-0">Charge & Demurrage Report</h4>
                            <p class="mb-0 small">Port of Chittagong, Bangladesh</p>
                        </div>
                        <div class="text-end">
                            <small>Report Date</small>
                            <p class="fw-bold mb-0" id="report-date"></p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4 p-md-5">
                    <h5 class="section-title">Shipment Information</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6"><small class="text-muted">B/L Number</small><div class="fw-bold" id="res-bl"></div></div>
                        <div class="col-md-6"><small class="text-muted">Container ID</small><div class="fw-bold" id="res-container"></div></div>
                        <div class="col-md-6"><small class="text-muted">Vessel / Voyage</small><div class="fw-bold" id="res-vessel"></div></div>
                        <div class="col-md-6"><small class="text-muted">Consignee</small><div class="fw-bold" id="res-consignee"></div></div>
                        <div class="col-md-6"><small class="text-muted">Container Type</small><div class="fw-bold" id="res-type"></div></div>
                        <div class="col-md-6"><small class="text-muted">Discharge Date</small><div class="fw-bold" id="res-discharge"></div></div>
                    </div>
                    <h5 class="section-title">Charges Breakdown</h5>
                    <table class="table table-bordered charges-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Port Handling Charges</td>
                                <td class="text-end" id="res-port-charges"></td>
                            </tr>
                            <tr>
                                <td>Agency Fee</td>
                                <td class="text-end" id="res-agency-fee"></td>
                            </tr>
                            <tr>
                                <td>Documentation Fee</td>
                                <td class="text-end" id="res-doc-fee"></td>
                            </tr>
                            <tr>
                                <td>Amendment Fee</td>
                                <td class="text-end" id="res-amend-fee"></td>
                            </tr>
                            <tr>
                                <td>Container Demurrage (<span id="res-dem-days"></span> days)</td>
                                <td class="text-end" id="res-dem-amount"></td>
                            </tr>
                            <tr class="total-row">
                                <td>TOTAL AMOUNT DUE</td>
                                <td class="text-end" id="res-total"></td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <h6 class="mb-0">Payment Status:</h6>
                        <span class="fs-5" id="res-status"></span>
                    </div>
                </div>
            </div>
            <div class="card-footer text-center py-3 no-print">
                <button class="btn btn-secondary" onclick="window.print()"><i class="bi bi-printer me-2"></i>Print Report</button>
                <button class="btn btn-success" onclick="generatePDF()"><i class="bi bi-file-earmark-pdf me-2"></i>Download PDF</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        let containerData = [];

        // Load data on start
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('./data.json');
                if (!response.ok) throw new Error('Data file not found.');
                containerData = await response.json();
            } catch (error) {
                showError('Could not load portal data. Please contact the MSC office.');
                console.error(error);
            }
        });

        // Handle search form submission
        document.getElementById('search-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const blNumber = document.getElementById('bl-search').value.trim().toUpperCase();
            searchBL(blNumber);
        });

        function searchBL(blNumber) {
            hideError();
            const resultsCard = document.getElementById('results-card');
            const record = containerData.find(item => item.BL_Number.toUpperCase() === blNumber);

            if (record) {
                // Calculate Demurrage
                const demurrageAmount = parseFloat(record.Demurrage_Days) * parseFloat(record.Demurrage_Rate_USD);

                // Populate data
                document.getElementById('report-date').textContent = new Date().toLocaleDateString();
                document.getElementById('res-bl').textContent = record.BL_Number;
                document.getElementById('res-container').textContent = record.Container_ID;
                document.getElementById('res-vessel').textContent = `${record.Vessel_Name} / ${record.Voyage}`;
                document.getElementById('res-consignee').textContent = record.Consignee;
                document.getElementById('res-type').textContent = record.Container_Type;
                document.getElementById('res-discharge').textContent = record.Discharge_Date;

                document.getElementById('res-port-charges').textContent = `BDT ${parseFloat(record.Port_Charges_BDT).toLocaleString()}`;
                document.getElementById('res-agency-fee').textContent = `USD ${parseFloat(record.Agency_Fee_USD).toFixed(2)}`;
                document.getElementById('res-doc-fee').textContent = `USD ${parseFloat(record.Documentation_Fee_USD).toFixed(2)}`;
                document.getElementById('res-amend-fee').textContent = `USD ${parseFloat(record.Amendment_Fee_USD).toFixed(2)}`;
                document.getElementById('res-dem-days').textContent = record.Demurrage_Days;
                document.getElementById('res-dem-amount').textContent = `USD ${demurrageAmount.toFixed(2)}`;
                document.getElementById('res-total').textContent = `USD ${parseFloat(record.Total_Due_USD).toFixed(2)}`;
                
                // Set status style
                const statusEl = document.getElementById('res-status');
                statusEl.textContent = record.Payment_Status.replace('_', ' ');
                statusEl.className = `status-${record.Payment_Status.toLowerCase()}`;

                // Show results card with animation
                resultsCard.classList.add('show');
            } else {
                showError('Bill of Lading number not found. Please check the number and try again.');
                resultsCard.classList.remove('show');
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const reportContent = document.getElementById('report-content');
            const blNumber = document.getElementById('res-bl').textContent;
            
            html2canvas(reportContent, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`MSC_Report_${blNumber}.pdf`);
            });
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
    </script>
</body>
</html>